{% extends "base.html" %}
{% block title %}Dashboard | Tambasa{% endblock %}

{% block extra_style %}
<style>
.stats-card {
    transition: transform 0.2s;
    height: 100%;
    min-height: 120px;
}
.stats-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.1);
}
.stats-card .card-body {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
}
.filters-section {
    background-color: #f8f9fa;
    color: #343a40;
}
.table-responsive {
    border-radius: 10px;
    overflow: hidden;
}
.search-box {
    border-radius: 25px;
}
.nav-tabs .nav-link {
    color: #495057;
}
.nav-tabs .nav-link.active {
    color: #007bff;
    border-color: #dee2e6 #dee2e6 #fff;
    font-weight: bold;
}
.btn-light {
    background-color: #fff;
    border-color: #dee2e6;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h1 class="h2 mb-4">Dashboard de Monitoramento</h1>

    <!-- Abas -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'api' %}active{% endif %}" href="?tab=api">
                <i class="bi bi-hdd-stack-fill me-1"></i> Requisições API
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'messages' %}active{% endif %}" href="?tab=messages">
                <i class="bi bi-chat-dots-fill me-1"></i> Mensagens Z-API
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link {% if active_tab == 'delivery' %}active{% endif %}" href="?tab=delivery">
                <i class="bi bi-truck me-1"></i> Entregas (Delivery)
            </a>
        </li>
    </ul>

    {% if active_tab == "api" %}
        <!-- Conteúdo da aba API -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-server fs-2 text-primary"></i>
                        <h6 class="mt-2">Total</h6>
                        <span class="display-6 fw-bold">{{ stats.total_requests|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle-fill fs-2 text-success"></i>
                        <h6 class="mt-2">Sucesso</h6>
                        <span class="display-6 fw-bold">{{ stats.success_requests|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-x-circle-fill fs-2 text-danger"></i>
                        <h6 class="mt-2">Falhas</h6>
                        <span class="display-6 fw-bold">{{ stats.failed_requests|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-globe fs-2 text-info"></i>
                        <h6 class="mt-2">IPs Únicos</h6>
                        <span class="display-6 fw-bold">{{ stats.unique_ips|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-speedometer2 fs-2 text-warning"></i>
                        <h6 class="mt-2">Tempo Médio</h6>
                        <span class="display-6 fw-bold">{{ stats.avg_time|default:"0" }}</span>
                        <small class="text-muted">ms</small>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-clock-history fs-2 text-secondary"></i>
                        <h6 class="mt-2">Última Requisição</h6>
                        <span class="fw-bold">{{ stats.last_request|default:"-" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card filters-section border-0 shadow-sm mb-4">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <input type="hidden" name="tab" value="api">
                    <div class="col-md-2">
                        <label class="form-label">Nº da Carga</label>
                        <input type="text" name="carga_number" class="form-control search-box" placeholder="Buscar..." value="{{ carga_number }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="request_status" class="form-select search-box">
                            <option value="">Todos</option>
                            <option value="success" {% if request_status == "success" %}selected{% endif %}>Sucesso</option>
                            <option value="invalid_token" {% if request_status == "invalid_token" %}selected{% endif %}>Token Inválido</option>
                            <option value="invalid_input" {% if request_status == "invalid_input" %}selected{% endif %}>Entrada Inválida</option>
                            <option value="system_error" {% if request_status == "system_error" %}selected{% endif %}>Erro de Sistema</option>
                            <option value="timeout" {% if request_status == "timeout" %}selected{% endif %}>Timeout</option>
                            <option value="rate_limited" {% if request_status == "rate_limited" %}selected{% endif %}>Rate Limited</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Token</label>
                        <select name="token" class="form-select search-box">
                            <option value="">Todos</option>
                            {% for token in available_tokens %}
                            <option value="{{ token.id }}" {% if token_id == token.id|stringformat:"s" %}selected{% endif %}>
                                {{ token.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" name="start_date" class="form-control search-box" value="{{ start_date }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Final</label>
                        <input type="date" name="end_date" class="form-control search-box" value="{{ end_date }}">
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-light text-primary fw-bold">
                            <i class="bi bi-funnel-fill me-1"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de logs -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-list-ul me-2"></i>Logs da API</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Data/Hora</th>
                                <th>IP</th>
                                <th>Token</th>
                                <th>Carga</th>
                                <th>Status</th>
                                <th>Resposta</th>
                                <th>Tempo (ms)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in api_logs %}
                            <tr>
                                <td>{{ log.created_at|date:"d/m/Y H:i:s" }}</td>
                                <td>{{ log.ip_address }}</td>
                                <td>{{ log.api_token.name|default:"-" }}</td>
                                <td>{{ log.carga_number }}</td>
                                <td>
                                    {% if log.request_status == 'success' %}
                                        <span class="badge bg-success">Sucesso</span>
                                    {% elif 'error' in log.request_status or 'invalid' in log.request_status %}
                                        <span class="badge bg-danger">{{ log.get_request_status_display }}</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">{{ log.get_request_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ log.response_message|truncatewords:10|default:"-" }}</td>
                                <td>{{ log.processing_time_ms|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">Nenhuma requisição encontrada.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include "pagination.html" %}
            </div>
        </div>

    {% elif active_tab == "delivery" %}
        <!-- Conteúdo da aba Delivery -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-truck fs-2 text-primary"></i>
                        <h6 class="mt-2">Total Callbacks</h6>
                        <span class="display-6 fw-bold">{{ stats.total_callbacks|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle-fill fs-2 text-success"></i>
                        <h6 class="mt-2">Sucesso</h6>
                        <span class="display-6 fw-bold">{{ stats.success_callbacks|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-question-circle-fill fs-2 text-warning"></i>
                        <h6 class="mt-2">Não Encontrado</h6>
                        <span class="display-6 fw-bold">{{ stats.not_found_callbacks|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-x-circle-fill fs-2 text-danger"></i>
                        <h6 class="mt-2">Erros</h6>
                        <span class="display-6 fw-bold">{{ stats.forward_error_callbacks|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-speedometer2 fs-2 text-info"></i>
                        <h6 class="mt-2">Tempo Médio</h6>
                        <span class="display-6 fw-bold">{{ stats.avg_time|default:"-" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-clock-history fs-2 text-secondary"></i>
                        <h6 class="mt-2">Último Callback</h6>
                        <span class="fw-bold">{{ stats.last_callback|default:"-" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card filters-section border-0 shadow-sm mb-4">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <input type="hidden" name="tab" value="delivery">
                    <div class="col-md-3">
                        <label class="form-label">Message ID</label>
                        <input type="text" name="message_id" class="form-control search-box" placeholder="Buscar..." value="{{ message_id }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="webhook_status" class="form-select search-box">
                            <option value="">Todos</option>
                            <option value="success" {% if webhook_status == "success" %}selected{% endif %}>Sucesso</option>
                            <option value="not_found" {% if webhook_status == "not_found" %}selected{% endif %}>Não Encontrado</option>
                            <option value="forward_error" {% if webhook_status == "forward_error" %}selected{% endif %}>Erro</option>
                            <option value="invalid_payload" {% if webhook_status == "invalid_payload" %}selected{% endif %}>Payload Inválido</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" name="start_date" class="form-control search-box" value="{{ start_date }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Final</label>
                        <input type="date" name="end_date" class="form-control search-box" value="{{ end_date }}">
                    </div>
                    <div class="col-md-3 d-grid">
                        <button type="submit" class="btn btn-light text-primary fw-bold">
                            <i class="bi bi-funnel-fill me-1"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de logs de delivery -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-truck me-2"></i>Logs de Delivery</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Data/Hora</th>
                                <th>Message ID</th>
                                <th>Mensagem</th>
                                <th>Status</th>
                                <th>IP</th>
                                <th>HTTP Code</th>
                                <th>Tempo (ms)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for log in delivery_logs %}
                            <tr>
                                <td>{{ log.created_at|date:"d/m/Y H:i:s" }}</td>
                                <td>{{ log.message_id|truncatechars:20 }}</td>
                                <td>{{ log.delivery_message|truncatechars:40|default:"-" }}</td>
                                <td>
                                    {% if log.webhook_status == 'success' %}
                                        <span class="badge bg-success">Sucesso</span>
                                    {% elif log.webhook_status == 'not_found' %}
                                        <span class="badge bg-warning text-dark">Não Encontrado</span>
                                    {% elif log.webhook_status == 'forward_error' %}
                                        <span class="badge bg-danger">Erro</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ log.get_webhook_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ log.ip_address }}</td>
                                <td>{{ log.internal_route_status_code|default:"-" }}</td>
                                <td>{{ log.processing_time_ms|default:"-" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">Nenhum callback encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include "pagination.html" %}
            </div>
        </div>

    {% else %}
        <!-- Conteúdo da aba Messages -->
        <div class="row mb-4">
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-envelope-fill fs-2 text-primary"></i>
                        <h6 class="mt-2">Mensagens</h6>
                        <span class="display-6 fw-bold">{{ stats.total_messages|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-person-lines-fill fs-2 text-info"></i>
                        <h6 class="mt-2">Contatos</h6>
                        <span class="display-6 fw-bold">{{ stats.unique_contacts|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-people-fill fs-2 text-secondary"></i>
                        <h6 class="mt-2">Grupos</h6>
                        <span class="display-6 fw-bold">{{ stats.groups|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle-fill fs-2 text-success"></i>
                        <h6 class="mt-2">Reencaminhadas</h6>
                        <span class="display-6 fw-bold">{{ stats.forwarded|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-x-circle-fill fs-2 text-danger"></i>
                        <h6 class="mt-2">Falhas</h6>
                        <span class="display-6 fw-bold">{{ stats.failed|default:"0" }}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="bi bi-clock-history fs-2 text-secondary"></i>
                        <h6 class="mt-2">Última Mensagem</h6>
                        <span class="fw-bold">{{ stats.last_message|default:"-" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card filters-section border-0 shadow-sm mb-4">
            <div class="card-body">
                <form method="get" class="row g-3 align-items-end">
                    <input type="hidden" name="tab" value="messages">
                    <div class="col-md-2">
                        <label class="form-label">Telefone</label>
                        <input type="text" name="phone" class="form-control search-box" placeholder="Buscar..." value="{{ phone }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select search-box">
                            <option value="">Todos</option>
                            <option value="success" {% if status == "success" %}selected{% endif %}>Sucesso</option>
                            <option value="failed" {% if status == "failed" %}selected{% endif %}>Falha</option>
                            <option value="pending" {% if status == "pending" %}selected{% endif %}>Pendente</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Inicial</label>
                        <input type="date" name="start_date" class="form-control search-box" value="{{ start_date }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Data Final</label>
                        <input type="date" name="end_date" class="form-control search-box" value="{{ end_date }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tipo</label>
                        <select name="is_group" class="form-select search-box">
                            <option value="">Todos</option>
                            <option value="true" {% if is_group == "true" %}selected{% endif %}>Grupo</option>
                            <option value="false" {% if is_group == "false" %}selected{% endif %}>Individual</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-grid">
                        <button type="submit" class="btn btn-light text-primary fw-bold">
                            <i class="bi bi-funnel-fill me-1"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Tabela de mensagens -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h5 class="card-title mb-3"><i class="bi bi-envelope-open me-2"></i>Mensagens Recebidas</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Data/Hora</th>
                                <th>Telefone</th>
                                <th>Mensagem</th>
                                <th>Status</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for msg in messages %}
                            <tr>
                                <td>{{ msg.created_at|date:"d/m/Y H:i:s" }}</td>
                                <td>{{ msg.phone }}</td>
                                <td>{{ msg.message|truncatechars:50|escape }}</td>
                                <td>
                                    {% if msg.external_system_status == 'success' %}
                                        <span class="badge bg-success">Sucesso</span>
                                    {% elif msg.external_system_status == 'failed' %}
                                        <span class="badge bg-danger">Falha</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Pendente</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if msg.is_group %}
                                        <span class="badge bg-info text-dark">Grupo</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Individual</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Nenhuma mensagem encontrada.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include "pagination.html" %}
            </div>
        </div>
    {% endif %}
</div>

{% endblock %}
